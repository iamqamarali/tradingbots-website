<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Trading Bot Manager</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PWA Support -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#fbbf24">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TradingBot">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
</head>
<body>
    <div class="app-container">
        {% include 'includes/sidebar.html' %}

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <div class="header-title">
                        <h1>Dashboard</h1>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Trading Rules Sections Header -->
                <div class="rules-header">
                    <h2>Trading Rules</h2>
                    <button class="add-section-btn" id="addSectionBtn" title="Add Section">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add Section
                    </button>
                </div>

                <!-- Dynamic Trading Rules Sections Container -->
                <div class="trading-rules-container" id="ruleSectionsContainer">
                    <div class="rules-loading" id="sectionsLoading">
                        <div class="spinner"></div>
                        <p>Loading sections...</p>
                    </div>
                </div>

                <!-- Open Positions Section -->
                <div class="positions-section" id="dashboardPositions">
                    <div class="section-header">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/>
                                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                            </svg>
                            Open Positions
                            <span class="position-count" id="positionCount">0</span>
                        </h2>
                        <div class="section-actions">
                            <button class="action-btn calc-btn" id="positionCalcBtn" title="Position Size Calculator">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                                    <line x1="8" y1="6" x2="16" y2="6"/>
                                    <line x1="8" y1="10" x2="16" y2="10"/>
                                    <rect x="8" y="14" width="3" height="3"/>
                                    <rect x="13" y="14" width="3" height="3"/>
                                </svg>
                                <span>Calculator</span>
                            </button>
                            <button class="refresh-btn" id="refreshPositionsBtn" title="Refresh Positions">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div class="positions-container" id="positionsContainer">
                        <div class="positions-loading" id="positionsLoading">
                            <div class="spinner"></div>
                            <p>Loading positions...</p>
                        </div>
                        <div class="positions-table-wrapper" id="positionsTableWrapper" style="display: none;">
                            <table class="positions-table" id="positionsTable">
                                <thead>
                                    <tr>
                                        <th>Account</th>
                                        <th>Symbol</th>
                                        <th>Side</th>
                                        <th>Size</th>
                                        <th>Entry Price</th>
                                        <th>Mark Price</th>
                                        <th>SL / TP</th>
                                        <th>PnL</th>
                                        <th>Leverage</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="empty-positions" id="emptyPositions" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 12h8"/>
                            </svg>
                            <p>No open positions</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Close Position Modal -->
    <div class="modal-overlay" id="closePositionModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Close Position</h3>
                <button class="modal-close" id="closePositionModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="position-info">
                    <span class="position-symbol" id="closePositionSymbol">BTCUSDT</span>
                    <span class="position-side" id="closePositionSide">LONG</span>
                    <span class="position-account" id="closePositionAccount"></span>
                </div>
                <div class="position-details">
                    <div class="detail-row">
                        <span>Position Size</span>
                        <span id="closePositionSize">0</span>
                    </div>
                    <div class="detail-row">
                        <span>Unrealized PnL</span>
                        <span id="closePositionPnl">$0.00</span>
                    </div>
                </div>
                <div class="close-order-type-section">
                    <label>Order Type</label>
                    <div class="order-type-toggle" id="closeOrderTypeToggle">
                        <button class="toggle-btn active" data-type="MARKET">Market</button>
                        <button class="toggle-btn" data-type="BBO">BBO</button>
                    </div>
                </div>
                <div class="close-amount-section">
                    <label>Amount to Close</label>
                    <div class="percentage-buttons">
                        <button class="pct-btn" data-pct="25">25%</button>
                        <button class="pct-btn" data-pct="50">50%</button>
                        <button class="pct-btn" data-pct="75">75%</button>
                        <button class="pct-btn active" data-pct="100">100%</button>
                    </div>
                    <div class="slider-container">
                        <input type="range" class="percentage-slider" id="closePercentageSlider" min="1" max="100" value="100">
                        <span class="slider-value" id="closePercentageValue">100%</span>
                    </div>
                    <div class="close-quantity">
                        <span>Quantity to Close</span>
                        <span id="closeQuantityValue">0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelClosePosition">Cancel</button>
                <button class="btn-danger" id="confirmClosePosition">Market Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Stop Loss Modal -->
    <div class="modal-overlay" id="editStopLossModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3>Edit Stop Loss</h3>
                <button class="modal-close" id="editStopLossModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="position-info">
                    <span class="position-symbol" id="slSymbol">BTCUSDT</span>
                    <span class="position-side" id="slSide">LONG</span>
                    <span class="position-account" id="slAccount"></span>
                </div>
                <div class="form-group">
                    <label>Current Stop Loss</label>
                    <p id="slCurrentStop" class="no-sl">None</p>
                </div>
                <div class="form-group">
                    <label for="newStopPrice">New Stop Price</label>
                    <input type="number" id="newStopPrice" step="any" placeholder="Enter stop price">
                    <p class="stop-loss-hint">
                        <span class="hint-warning" id="slHint"></span>
                    </p>
                </div>
                <div class="potential-loss-display" id="slPotentialLossSection" style="display: none;">
                    <div class="detail-row loss-row">
                        <span>Potential Loss:</span>
                        <span id="slPotentialLoss" class="loss-amount">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="removeStopLossBtn" style="margin-right: auto;">Remove SL</button>
                <button class="btn-secondary" id="cancelEditStopLoss">Cancel</button>
                <button class="btn-primary" id="confirmEditStopLoss">Update Stop Loss</button>
            </div>
        </div>
    </div>

    <!-- Edit Take Profit Modal -->
    <div class="modal-overlay" id="editTakeProfitModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3>Edit Take Profit</h3>
                <button class="modal-close" id="editTakeProfitModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="position-info">
                    <span class="position-symbol" id="tpSymbol">BTCUSDT</span>
                    <span class="position-side" id="tpSide">LONG</span>
                    <span class="position-account" id="tpAccount"></span>
                </div>
                <div class="form-group">
                    <label>Current Take Profit</label>
                    <p id="tpCurrentTP" class="no-tp">None</p>
                </div>
                <div class="form-group">
                    <label for="newTakeProfitPrice">New Take Profit Price</label>
                    <input type="number" id="newTakeProfitPrice" step="any" placeholder="Enter take profit price">
                    <p class="take-profit-hint">
                        <span class="hint-success" id="tpHint"></span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="removeTakeProfitBtn" style="margin-right: auto;">Remove TP</button>
                <button class="btn-secondary" id="cancelEditTakeProfit">Cancel</button>
                <button class="btn-primary" id="confirmEditTakeProfit">Update Take Profit</button>
            </div>
        </div>
    </div>

    <!-- Add to Position Modal -->
    <div class="modal-overlay" id="addToPositionModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3>Add to Position</h3>
                <button class="modal-close" id="closeAddToPositionModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="position-info">
                    <span class="position-symbol" id="addPosSymbol">BTCUSDT</span>
                    <span class="position-side" id="addPosSide">LONG</span>
                    <span class="position-account" id="addPosAccount"></span>
                </div>
                <div class="position-details">
                    <div class="detail-row">
                        <span>Current Size:</span>
                        <span id="addPosCurrentSize">0.00</span>
                    </div>
                    <div class="detail-row">
                        <span>Entry Price:</span>
                        <span id="addPosEntryPrice">$0.00</span>
                    </div>
                    <div class="detail-row">
                        <span>Mark Price:</span>
                        <span id="addPosMarkPrice">$0.00</span>
                    </div>
                    <div class="detail-row">
                        <span>Leverage:</span>
                        <span id="addPosLeverage">1x</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="addPosUsdc">Size to Add (USDC)</label>
                    <input type="number" id="addPosUsdc" step="any" placeholder="Enter USDC amount...">
                    <div class="add-pos-quick-btns">
                        <button type="button" class="quick-btn" data-pct="25">25%</button>
                        <button type="button" class="quick-btn" data-pct="50">50%</button>
                        <button type="button" class="quick-btn" data-pct="75">75%</button>
                        <button type="button" class="quick-btn" data-pct="100">Max</button>
                    </div>
                    <div class="calculated-qty">
                        Quantity: <span id="addPosCalcQty">0.00</span>
                    </div>
                    <div class="add-pos-hint">
                        This will place a market order to increase your position size
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelAddToPosition">Cancel</button>
                <button class="btn-primary" id="confirmAddToPosition">Add to Position</button>
            </div>
        </div>
    </div>

    <!-- Position Size Calculator Modal -->
    <div class="modal-overlay" id="positionCalcModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3>Position Size Calculator</h3>
                <button class="modal-close" id="closePositionCalcModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="calcBalance">Account Balance (USD)</label>
                    <input type="number" id="calcBalance" step="0.01" placeholder="Enter your balance...">
                </div>
                <div class="form-group">
                    <label>Risk Percentage</label>
                    <div class="risk-buttons">
                        <button class="risk-btn" data-risk="1">1%</button>
                        <button class="risk-btn active" data-risk="2">2%</button>
                        <button class="risk-btn" data-risk="3">3%</button>
                        <button class="risk-btn" data-risk="5">5%</button>
                    </div>
                    <input type="number" id="calcRiskPercent" value="2" min="0.1" max="100" step="0.1" placeholder="Custom %">
                </div>
                <div class="form-group">
                    <label for="calcEntryPrice">Entry Price</label>
                    <input type="number" id="calcEntryPrice" step="any" placeholder="Enter entry price...">
                </div>
                <div class="form-group">
                    <label for="calcStopLoss">Stop Loss Price</label>
                    <input type="number" id="calcStopLoss" step="any" placeholder="Enter stop loss price...">
                </div>
                <div class="calc-results">
                    <div class="calc-result-row">
                        <span>Risk Amount</span>
                        <span id="calcRiskUsd" class="result-value">$0.00</span>
                    </div>
                    <div class="calc-result-row">
                        <span>Stop Distance</span>
                        <span id="calcStopDistance" class="result-value">0.00%</span>
                    </div>
                    <div class="calc-result-row highlight">
                        <span>Position Size</span>
                        <span id="calcPositionUsd" class="result-value highlight">$0.00</span>
                    </div>
                    <div class="calc-result-row">
                        <span>Quantity</span>
                        <span id="calcPositionQty" class="result-value">0.000</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="clearCalcBtn">Clear</button>
                <button class="btn-primary" id="doneCalcBtn">Done</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Rule Modal -->
    <div class="modal-overlay" id="ruleModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3 id="ruleModalTitle">Add Trading Rule</h3>
                <button class="modal-close" id="ruleModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ruleText">Rule</label>
                    <div class="formatting-toolbar">
                        <button type="button" class="format-btn" id="boldBtn" title="Bold (Ctrl+B)">
                            <strong>B</strong>
                        </button>
                        <button type="button" class="format-btn highlight-btn" id="highlightBtn" title="Highlight">
                            <span class="highlight-icon">H</span>
                        </button>
                    </div>
                    <textarea id="ruleText" rows="3" placeholder="Enter your trading rule..."></textarea>
                    <div class="format-hint">Select text and click Bold or Highlight to format</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelRuleBtn">Cancel</button>
                <button class="btn-primary" id="saveRuleBtn">Save Rule</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Section Modal -->
    <div class="modal-overlay" id="sectionModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3 id="sectionModalTitle">Add Section</h3>
                <button class="modal-close" id="sectionModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sectionName">Section Name</label>
                    <input type="text" id="sectionName" placeholder="Enter section name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelSectionBtn">Cancel</button>
                <button class="btn-primary" id="saveSectionBtn">Save Section</button>
            </div>
        </div>
    </div>

    <!-- Delete Section Confirmation Modal -->
    <div class="modal-overlay" id="deleteSectionModal">
        <div class="modal modal-small">
            <div class="modal-header">
                <h3>Delete Section</h3>
                <button class="modal-close" id="deleteSectionModalClose">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteSectionName"></span>"?</p>
                <p class="delete-warning">This will also delete all rules in this section.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelDeleteSectionBtn">Cancel</button>
                <button class="btn-danger" id="confirmDeleteSectionBtn">Delete Section</button>
            </div>
        </div>
    </div>

    <script src="/static/script.js"></script>
    <script>
        // Trading Rules Management - Dynamic Sections
        let ruleSections = [];
        let editingRuleId = null;
        let editingSectionId = null;
        let editingSectionForEdit = null;
        let deletingSectionId = null;

        async function loadRuleSections() {
            const container = document.getElementById('ruleSectionsContainer');
            const loading = document.getElementById('sectionsLoading');

            if (loading) loading.style.display = 'flex';

            try {
                const response = await fetch('/api/rule-sections');
                ruleSections = await response.json();

                if (loading) loading.style.display = 'none';
                renderSections();
            } catch (error) {
                console.error('Error loading sections:', error);
                if (loading) loading.style.display = 'none';
                container.innerHTML = '<div class="empty-rules"><p>Error loading sections</p></div>';
            }
        }

        function renderSections() {
            const container = document.getElementById('ruleSectionsContainer');

            if (ruleSections.length === 0) {
                container.innerHTML = `
                    <div class="empty-sections">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                            <rect x="9" y="3" width="6" height="4" rx="1"/>
                        </svg>
                        <p>No trading rules sections yet</p>
                        <button class="btn-primary" onclick="openSectionModal()">Create First Section</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = ruleSections.map(section => `
                <div class="trading-rules-section" data-section-id="${section.id}">
                    <div class="section-header">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                            </svg>
                            <span class="section-name">${escapeHtml(section.name)}</span>
                        </h2>
                        <div class="section-actions">
                            <button class="action-btn" onclick="openRuleModal(${section.id})" title="Add Rule">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                            </button>
                            <button class="action-btn edit-section-btn" onclick="openSectionModal(${section.id})" title="Edit Section">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete-section-btn" onclick="confirmDeleteSection(${section.id}, '${escapeHtml(section.name)}')" title="Delete Section">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="rules-container">
                        ${section.rules.length === 0 ? `
                            <div class="empty-rules">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                                    <rect x="9" y="3" width="6" height="4" rx="1"/>
                                </svg>
                                <p>No rules yet</p>
                            </div>
                        ` : `
                            <ul class="rules-list">
                                ${section.rules.map((rule, index) => `
                                    <li class="rule-item" data-id="${rule.id}">
                                        <span class="rule-number">${index + 1}.</span>
                                        <span class="rule-text">${formatRuleText(rule.rule_text)}</span>
                                        <div class="rule-actions">
                                            <button class="rule-btn edit-btn" onclick="editRule(${rule.id}, ${section.id})" title="Edit">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                </svg>
                                            </button>
                                            <button class="rule-btn delete-btn" onclick="deleteRule(${rule.id})" title="Delete">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="3 6 5 6 21 6"/>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        `}
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatRuleText(text) {
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/==(.+?)==/g, '<mark>$1</mark>');
            return formatted;
        }

        function wrapSelectedText(textarea, prefix, suffix) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);

            if (selectedText.length === 0) {
                textarea.value = text.substring(0, start) + prefix + suffix + text.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + prefix.length;
            } else {
                textarea.value = text.substring(0, start) + prefix + selectedText + suffix + text.substring(end);
                textarea.selectionStart = start + prefix.length;
                textarea.selectionEnd = end + prefix.length;
            }
            textarea.focus();
        }

        // Section Modal Functions
        function openSectionModal(sectionId = null) {
            const modal = document.getElementById('sectionModal');
            const title = document.getElementById('sectionModalTitle');
            const nameInput = document.getElementById('sectionName');
            const saveBtn = document.getElementById('saveSectionBtn');

            editingSectionForEdit = sectionId;

            if (sectionId) {
                const section = ruleSections.find(s => s.id === sectionId);
                title.textContent = 'Edit Section';
                nameInput.value = section ? section.name : '';
                saveBtn.textContent = 'Update Section';
            } else {
                title.textContent = 'Add Section';
                nameInput.value = '';
                saveBtn.textContent = 'Save Section';
            }

            modal.classList.add('active');
            nameInput.focus();
        }

        function closeSectionModal() {
            document.getElementById('sectionModal').classList.remove('active');
            editingSectionForEdit = null;
        }

        async function saveSection() {
            const nameInput = document.getElementById('sectionName');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('Please enter a section name', 'error');
                return;
            }

            try {
                if (editingSectionForEdit) {
                    await fetch(`/api/rule-sections/${editingSectionForEdit}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    showToast('Section updated', 'success');
                } else {
                    await fetch('/api/rule-sections', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    showToast('Section added', 'success');
                }

                closeSectionModal();
                loadRuleSections();
            } catch (error) {
                console.error('Error saving section:', error);
                showToast('Error saving section', 'error');
            }
        }

        function confirmDeleteSection(sectionId, sectionName) {
            deletingSectionId = sectionId;
            document.getElementById('deleteSectionName').textContent = sectionName;
            document.getElementById('deleteSectionModal').classList.add('active');
        }

        function closeDeleteSectionModal() {
            document.getElementById('deleteSectionModal').classList.remove('active');
            deletingSectionId = null;
        }

        async function deleteSection() {
            if (!deletingSectionId) return;

            try {
                await fetch(`/api/rule-sections/${deletingSectionId}`, { method: 'DELETE' });
                showToast('Section deleted', 'success');
                closeDeleteSectionModal();
                loadRuleSections();
            } catch (error) {
                console.error('Error deleting section:', error);
                showToast('Error deleting section', 'error');
            }
        }

        // Rule Modal Functions
        function openRuleModal(sectionId, ruleId = null) {
            const modal = document.getElementById('ruleModal');
            const title = document.getElementById('ruleModalTitle');
            const textInput = document.getElementById('ruleText');
            const saveBtn = document.getElementById('saveRuleBtn');

            editingRuleId = ruleId;
            editingSectionId = sectionId;

            const section = ruleSections.find(s => s.id === sectionId);
            const sectionName = section ? section.name : 'Trading';

            if (ruleId) {
                const rule = section?.rules.find(r => r.id === ruleId);
                title.textContent = 'Edit Rule';
                textInput.value = rule ? rule.rule_text : '';
                saveBtn.textContent = 'Update Rule';
            } else {
                title.textContent = `Add Rule to ${sectionName}`;
                textInput.value = '';
                saveBtn.textContent = 'Save Rule';
            }

            modal.classList.add('active');
            textInput.focus();
        }

        function closeRuleModal() {
            document.getElementById('ruleModal').classList.remove('active');
            editingRuleId = null;
            editingSectionId = null;
        }

        function editRule(ruleId, sectionId) {
            openRuleModal(sectionId, ruleId);
        }

        async function saveRule() {
            const textInput = document.getElementById('ruleText');
            const ruleText = textInput.value.trim();

            if (!ruleText) {
                showToast('Please enter a rule', 'error');
                return;
            }

            try {
                if (editingRuleId) {
                    await fetch(`/api/trading-rules/${editingRuleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rule_text: ruleText })
                    });
                    showToast('Rule updated', 'success');
                } else {
                    await fetch('/api/trading-rules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rule_text: ruleText, section_id: editingSectionId })
                    });
                    showToast('Rule added', 'success');
                }

                closeRuleModal();
                loadRuleSections();
            } catch (error) {
                console.error('Error saving rule:', error);
                showToast('Error saving rule', 'error');
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule?')) return;

            try {
                await fetch(`/api/trading-rules/${ruleId}`, { method: 'DELETE' });
                showToast('Rule deleted', 'success');
                loadRuleSections();
            } catch (error) {
                console.error('Error deleting rule:', error);
                showToast('Error deleting rule', 'error');
            }
        }

        // Initialize
        function initTradingRules() {
            loadRuleSections();

            // Add section button
            document.getElementById('addSectionBtn').addEventListener('click', () => openSectionModal());

            // Section modal controls
            document.getElementById('sectionModalClose').addEventListener('click', closeSectionModal);
            document.getElementById('cancelSectionBtn').addEventListener('click', closeSectionModal);
            document.getElementById('saveSectionBtn').addEventListener('click', saveSection);
            document.getElementById('sectionModal').addEventListener('click', (e) => {
                if (e.target.id === 'sectionModal') closeSectionModal();
            });
            document.getElementById('sectionName').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveSection();
                }
            });

            // Delete section modal controls
            document.getElementById('deleteSectionModalClose').addEventListener('click', closeDeleteSectionModal);
            document.getElementById('cancelDeleteSectionBtn').addEventListener('click', closeDeleteSectionModal);
            document.getElementById('confirmDeleteSectionBtn').addEventListener('click', deleteSection);
            document.getElementById('deleteSectionModal').addEventListener('click', (e) => {
                if (e.target.id === 'deleteSectionModal') closeDeleteSectionModal();
            });

            // Rule modal controls
            document.getElementById('ruleModalClose').addEventListener('click', closeRuleModal);
            document.getElementById('cancelRuleBtn').addEventListener('click', closeRuleModal);
            document.getElementById('saveRuleBtn').addEventListener('click', saveRule);
            document.getElementById('ruleModal').addEventListener('click', (e) => {
                if (e.target.id === 'ruleModal') closeRuleModal();
            });
            document.getElementById('ruleText').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveRule();
                }
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    wrapSelectedText(e.target, '**', '**');
                }
            });

            // Formatting buttons
            document.getElementById('boldBtn').addEventListener('click', () => {
                wrapSelectedText(document.getElementById('ruleText'), '**', '**');
            });
            document.getElementById('highlightBtn').addEventListener('click', () => {
                wrapSelectedText(document.getElementById('ruleText'), '==', '==');
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTradingRules);
        } else {
            initTradingRules();
        }

        // User dropdown toggle
        const userAvatarBtn = document.getElementById('userAvatarBtn');
        const userDropdown = document.getElementById('userDropdown');

        if (userAvatarBtn && userDropdown) {
            userAvatarBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
            });

            document.addEventListener('click', (e) => {
                if (!userDropdown.contains(e.target) && !userAvatarBtn.contains(e.target)) {
                    userDropdown.classList.remove('active');
                }
            });
        }

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        if (mobileMenuBtn && sidebar && mobileOverlay) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileOverlay.classList.toggle('active');
            });

            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileOverlay.classList.remove('active');
            });
        }
    </script>
</body>
</html>
